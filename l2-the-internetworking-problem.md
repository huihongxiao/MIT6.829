# L2-The Internetworking Problem

英文原文：[https://ocw.mit.edu/courses/electrical-engineering-and-computer-science/6-829-computer-networks-fall-2002/lecture-notes/L2Internetworking.pdf](https://ocw.mit.edu/courses/electrical-engineering-and-computer-science/6-829-computer-networks-fall-2002/lecture-notes/L2Internetworking.pdf)

## Overview

这节课会来看将不同网络互联在一起会有哪些问题。我们会学习互联网的设计原则，IP，互联网尽力而为（best-effort）的服务模型，它的设计和协议准则。

之后我们讨论IP和TCP的区别，并学习TCP是如何完成可靠数据传输。我们会看TCP的ACK机制，以及两种形式的丢包重传：时间驱动（timer-driven）和数据驱动（data-driven）。前者依赖于预估连接的round-trip time（RTT）来设置超时，而后者依赖于接收到数据流中更靠后的包来避免等待超时。数据驱动重传的例子包括了快速重传（fast retransmission）和选择性确认（selective acknowledgment SACK）。

## 1. 网络互联的问题：许多不同类型的网络

上一节课，我们讨论了packet switching的原理，并且设计了一种方案来将LAN连接在一起。这里的核心在于一个叫做switch的设备，它会在不同的LAN之间转发packet。

尽管这样的网络可以工作，并且也很常见，它并不能用来构建一个全球的数据网络基础设施，它有两个主要的缺陷：

1. 它不能容纳异构性
2. 它并不能扩展到大规模网络

以上每一点都值得讨论。首先以太网绝不是世界上唯一的链路层技术，实际上，在以太网之前，packet在其他诸如无线射频，卫星信号，电话线等链路上传输。其次，以太网也通常不适用于几百公里的长距离传输。各种新的数据链路层技术一直在出现，并且会持续出现，而我们的目标就是确保任何新的数据链路层技术都可以接入到全球数据网络基础设施中。这就是容纳网络异构性的目标。

我们在[L1](l1-packet-switching.md#4.-yi-ge-li-zi-lan-switching)学习的LAN switching要求switch存储网络中每个host（实际上是每个网卡）的状态，如果switch中没有目的地址的状态，它会退而求其次将packet广播到整个网络中的所有链路上。这个在中等规模的主机数和链路数上都无法工作。

所以，网络互联的问题或许可以这样描述：设计个可扩展的网络基础设施，它能互联多个不同的小的网络，可以差异很大的网络上的主机之间能传递packet。

有关网络的差异，包含以下例子：

* **网络地址**。每个网络可能有自己地址格式。例如，以太网使用6个字节作为地址，而电话使用10位数字作为地址。
* **带宽和延时**。带宽可能会从几个bit/s到几个Gb/s，中间的跨度会有几个量级。类似的，延时也可能从几个微秒到几秒。
* **包大小**。不同网络的最大包尺寸可能会不同。
* **丢包率**。不同网络的丢包率和丢包模式都不相同。
* **路由模式**。不同网络的路由模式可能不同。例如射频网络的路由协议与有线网的路由协议就不一样。

从规模角度考虑，我们的目标就是尽可能的减少由switch维护的状态，和减少由控制流量消耗的带宽（例如路由信息，定期广播的消息等）。

### 1.1 Gateway

通过叫做gateway的设备可以帮助不同网络之间互联。Gateway可以连接具备不同特性的网络并在它们之间传递packet。至少存在两种连接方式可以连接不同的网络：翻译（translation）和统一的网络层（a unified network layer）。

基于翻译的网关会尽可能无感的，通过将packet header和协议从一个网络翻译到另一个网络来工作。这里的例子有OSI X.25/X.75 协议。翻译存在的主要问题包括：

* **功能缺失**。当翻译成另一种网络技术时，原有网络技术的功能（甚至是bug）不能被保留。对于用户来说，原有的一些假设就不成立了，因为一个特定的功能经过翻译之后就不再可用了。
* **差的扩展性**。翻译通常在需要互联的网络数较少，且其中每个网络也相对较小的场景下才能工作。它的扩展性较差因为翻译需要的信息与需要互联的网络数成平方的关系。这种方法被认为不能在大的互联网络中工作（值得注意的是，广泛部署的NAT网关使得互联网的一部分看起来像是翻译网关）。

### 1.2 互联网设计原则

互联网的设计者很早就发现了翻译的缺陷，并且认为正确的方法是在所有网络中标准化一些关键属性，并且定义少量的特性，让所有想连接到互联网的主机和网络都必须实现。

现在我们在回顾互联网协议时，已经可以识别并总结出藏在其中一些重要的设计原则。我们可以将这些原则分为两类：通用性（universality）和健壮性（robustness）。

#### 通用性原则

* IP-over-everything。所有的网络和主机都必须实现一个标准的网络协议 --- IP，也就是Internet Protocol。所有的网络和主机，如果想要能够从任意地址访问到，必须实现一个标准的定义好的地址规范。这样就可以避免翻译带来的扩展性问题，并且gateway也更容易实现了。
* 尽力而为的服务模型。gateway内部架构变得简单的一个结果就是服务模型变成了尽力而为。所有的packet都被同等对待，并且大多数时候不需要恢复网络中的丢包。这种定义好的简单的模型是互联网架构能够达到超大规模的主要原因。
* 端到端设计模式。这种设计模式是在最初的TCP/IP模型之后很久才总结出来，现在已经设计到互联网设计哲学的方方面面中了。TCP/IP的分层架构可以使得网络的内部变得简单，并且将所有复杂的机制例如稳定性，拥塞控制等放到终端主机，并且可以在主机上实现的更彻底。早期的设计（CK74）将TCP和IP一起实现在终端主机和gateway中，现在TCP和IP的分离，并将TCP从gateway中移除，是互联网变革的一个重要步骤。

#### 健壮性原则

* soft-state。大部分维护在gateway中的状态都是soft-state，就算它的数量很多或者被破坏了，也可以很容易的更新。Routing table就是一个很好的例子，gateway使用routing table来决定如何转发packet，而定期的路由更新避免了需要在router中实现复杂的错误处理程序。这样，gateway和路由协议被设计成在它们的常规操作中来客服故障，而不是在出错的时候需要特殊的机制。
* [fate sharing](https://en.wikipedia.org/wiki/Fate-sharing#:\~:text=Fate%2Dsharing%20is%20an%20engineering,was%20defined%20by%20David%20D.)。当一个主机与另一个主机通讯时，通讯对应的状态维护在系统中。在互联网，这里的关键状态在两个（或者多个）通讯主体中共享，而不会被网络中其他主机共享。如果一个终端主机故障了，其他主机的通讯状态也是故障，这样这些通讯主体共享了命运。如果一个gateway对于一个一条路由出现故障，端到端的通讯不会出现故障（注，这里应该是假设存在冗余线路），gateway中的状态是软的，并且gateway并不与终端主机共享命运。这与OSI X.25有明显的区别，在X.25中，gateway会维护硬的连接状态，并且终端主机会与gateway共享命运。
* 保守的发送/自由的接收（conservative-transmission/liberal reception）。”在发送的时候保守，在接收的时候自由。“这个针对网络协议的准则明显的增加了系统的健壮性。当一些从未交谈过的人共同编码一个大型系统时，这个原则尤其重要。甚至对于为一个规范写代码来说，这也是重要的，因为像英语一样的语言可能是模糊的，并且规范也会随时间变化。这个原则的一个例子体现在TCP协议中，一个TCP的发送端可能会收到一个它从来没有发送过packet的ACK。最差的反应是崩溃，因为发送端没有准备好接收它不曾预期的东西。但是这是错误的，现实中会悄悄的丢弃这个ACK，并看看从peer会来其他的数据。类似的，如果一个发送端发送一个带有非标准option的packet，它应该在协商之后才这么做。

### 1.3 互联网缺点

互联网并非没有缺点，很多缺点都是其最初设计目标的结果。

* 它的架构基本上依赖终端系统的可信赖性。它并没有考虑恶意终端系统的可能性，也没有考虑如何构建一个值得信赖的网络。
* 贪婪的发送端并没有较好的处理（特殊的用户，故障或者恶意的实现）。TCP可以很好的共享带宽，但是越来越多的流量并不是TCP。
* 在很长一段时间内，安全问题并没有像现在一样被重视。
* 较弱的审计和计费工具。这其实是最初的目标之一，但是并没有设计太多。
* 管理工具并不特别成熟。
* 增量部署。并不是一个基础的缺点，但是需要被每个协议设计者认识到。

### 1.4 互联网协议标准流程

互联网基础设置持续发展的一个有趣的方面是，标准设立和开发的过程。总的来说，这已经称为了一个非常成功的社会工程学的实践，来自许多不同组织的人朝着共识努力。IETF（Internet Engineering Task Force），一个自发的组织，是设立标准的主体。它会每4个月，按照working group的结构开一次会。这些working group从开始到终止通常都存活少于2年。互联网标准被记录在RFC（Request For Comments），并由IETF发布。可以查看http://www.ietf.org/获取更多信息。

Working group通过电子邮件完成大量的工作，并且对所有感兴趣的人开放。大体上来说，基于提案的投票是避免的，这里的流程喜欢”大体一致“。过去对于一个协议需要至少两个独立的实现，但是现在看起来这个要求被忽略了。
